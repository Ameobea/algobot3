"use strict";
/*jslint browser: true*/ /*global $*/

$(document).ready(()=>{
  //set up button listeners
  $("#instance-spawn-button").click(()=>{
    var type = $("#instance-type").val()
    var data = $("#instance-data-box").val();

    spawnInstance(type, data);
  });

  var serverAddress = "http://<%= ip %>";

  $("#backtestStartButton").click(()=>{
    var type = $("#backtestTypeSelector option:selected").text().toLowerCase();

    if(type == "fast"){
      var requestAddress = serverAddress + "api/backtest/start/fast/" + $("#backtestStartPair").val();
      $.post(requestAddress, {startTime: $("#backtestStartTime").val(), interval: $("#backtestSendInterval").val()});
    }else if(type == "live"){
      var requestAddress = serverAddress + "api/backtest/start/live/" + $("#backtestStartPair").val();
      $.post(requestAddress, {startTime: $("#backtestStartTime").val()});
    }else if(type == "pre-calculated"){
      var requestAddress = serverAddress + "api/backtest/start/precalced/" + $("#backtestStartPair").val();
      $.post(requestAddress, {startTime: $("#backtestStartTime").val(), endTime: $("#backtestEndTime").val()});
    }else if(type == "no-store"){
      var requestAddress = serverAddress + "api/backtest/start/nostore/" + $("#backtestStartPair").val();
      $.post(requestAddress, {startTime: $("#backtestStartTime").val()});
    }
  });

  $("#backtestTypeSelector").change(()=>{
    if($("#backtestTypeSelector option:selected").text().toLowerCase() == "pre-calculated"){
      $("#endtime").show();
    }else{
      $("#endtime").hide();
    }
  });

  $("#backtestStopButton").click(()=>{
    var requestAddress = serverAddress + "api/backtest/stop/" + $("#backtestStopPair").val();
    $.post(requestAddress);
  });

  $("#backtestStopAllButton").click(()=>{
    var requestAddress = serverAddress + "api/backtest/stop/all";
    $.post(requestAddress);
  });

  $("#dbFlush").click(()=>{
    $.get("api/utils/dbFlush");
  });

  $("#dbDump").click(()=>{
    $.get("api/utils/dbDump");
  })

  $("#dbRestore").click(()=>{
    var restoreId = $("#dbRestoreId").val();
    $.get("api/utils/dbRestore/" + restoreId);
  });

  loadInstances();
  loadConfig();
});

function decodeEntities(input){
  var y = document.createElement('textarea');
  y.innerHTML = input;
  return y.value;
}

var loadConfig = ()=>{
  <%
    var confString = "<table>";

    for(var key in conf.public){
      if(!conf.public.hasOwnProperty(key)) continue;

      confString += `<tr><td><b>${key}</b>: ${conf.public[key]}</td>`;
      confString += `<td><input type="text" id="confInput-${key}"><input type="button" class="confSubmit" id="confSubmit-${key}" value="Update"></td>`;
    }

    confString += "</table>";
  %>

  $("#config").html(decodeEntities(`<%= confString %>`));

  setupConfListeners();
}

var setupConfListeners = ()=>{
  $(".confSubmit").click(function(){
    var id = this.attributes.getNamedItem("id").value.split("-")[1];
    var val = $(`#confInput-${id}`).val();

    $.get(`./api/conf/set/${id}/${val}`, data=>{
      $("#configStatus").html(`<p>${data}</p>`);
      reloadConfig();
    });
  });
}

var reloadConfig = ()=>{
  $.get("./api/conf/get", data=>{
    $("#config").html(decodeEntities(data));

    setupConfListeners();
  });
}

var loadInstances = ()=>{
  update();
};

var update = ()=>{
  $.get("./api/instances", data=>{
    var parsed = JSON.parse(data);
    var table = "<table><tr><th>Kill</th><th>Type</th><th>Data</th></tr>";

    $.each(parsed.instances, (index, elem)=>{

      if(elem.type == "manager"){
        table += `<tr><td>${getKillButton(elem.type, elem)}</td><td>Manager</td><td>Port: <b>${elem.port}</b></td></tr>`;
      }else if(elem.type == "tickParser"){
        table += `<tr><td>${getKillButton(elem.type, elem)}</td><td>Tick Parser</td><td>Listening for pairs: <b>${elem.pairs}</b></td></tr>`;
      }
    });

    $.each(parsed.backtests, (index, elem)=>{
      table += `<tr><td>${getKillButton("backtest", elem)}</td><td>Backtest</td><td>Pair: <b>${elem.pair}</b></td></tr>`;// TODO: Add type to backtest
    });

    table += "</table>";

    $("#running-instances").html(table);
  }).fail(err=>{
    console.log("Unable to connect to ")
  })
}

var getKillButton = (type, data)=>{
  var include;

  if(type == "manager"){
    include = data.port;
  }else if(type == "tickParser"){
    include = data.id;
  }else if(type == "backtest"){
    include = data.pair;
  }

  return `<input type="button" onclick="killConfirm('${type}', '${include}')" value="X">`;
};

var killConfirm = (type, data)=>{
  var res = window.confirm("Are you sure you want to kill this instance?");
  if(res){
    killInstance(type, data);
  }
};

var killInstance = (type, data)=>{
  $.get(`./api/instances/kill/${type}/${data}`, res=>{
    $("#statusbar").html(res);
    update();
  }).fail(err=>{
    $("#statusbar").html(`<p>Failed to kill instance: ${err.status}</p>`);
  })
};

var spawnInstance = (type, data)=>{
  $.get(`./api/instances/spawn/${type}/${data}`, res=>{
    $("#statusbar").html(`Instance spawned with message: ${res}`);
    setTimeout(()=>{update();},500);
  });
}
